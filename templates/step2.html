{% extends "layout.html" %}

{% block title %}Шаг 2 - Заполните поля примерами{% endblock %}

{% block content %}
<h1>Заполните поля примерами</h1>

<div class="step-indicator">
    <div class="step completed">1</div>
    <div class="step active">2</div>
    <div class="step">3</div>
    <div class="step">4</div>
</div>

<form method="POST" id="examplesForm">
    <div id="examples-container">
        <!-- Первый блок примера будет здесь -->
    </div>
    
    <button type="button" id="add-example-btn" class="btn btn-add">
        <span class="btn-add-icon">+</span> Добавить ещё пример
    </button>
    
    <div class="btn-group">
        <a href="{{ url_for('step1') }}" class="btn btn-secondary">← Назад</a>
        <button type="submit" class="btn btn-primary">Далее →</button>
    </div>
</form>
{% endblock %}

{% block extra_css %}
<style>
    /* Увеличиваем ширину контейнера для этой страницы */
    .container {
        /* max-width: 1000px; */
        max-width: 800px;
    }
    
    .example-block {
        background: #f9f9f9;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        position: relative;
    }
    
    .example-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .example-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }
    
    .example-delete-btn {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 5px;
        background: #dc3545;
        color: white;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
    }
    
    .example-delete-btn:hover {
        background: #c82333;
    }
    
    .example-delete-btn:active {
        background: #bd2130;
    }
    
    .field-input-group {
        margin-bottom: 15px;
    }
    
    .field-label {
        display: block;
        margin-bottom: 6px;
        color: #555;
        font-weight: 500;
    }
    
    .field-textarea {
        width: 100%;
        padding: 10px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 16px;
        font-family: inherit;
        resize: none;
        min-height: 1.5em;
        line-height: 1.5;
        overflow: hidden;
        transition: border-color 0.3s;
    }
    
    .field-textarea:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .btn-add {
        background: #667eea;
        color: white;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-add:hover {
        background: #5568d3;
    }
    
    .btn-add:active {
        background: #4a5bc0;
    }
    
    .btn-add-icon {
        font-size: 20px;
        font-weight: bold;
    }
    
    /* Компактность по вертикали */
    h1 {
        margin-bottom: 8px;
    }
    
    .step-indicator {
        margin-bottom: 20px;
    }
    
    .btn-group {
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Данные о выбранных полях из сервера
    // @ts-ignore - Jinja2 template syntax, will be processed by server
    const selectedFields = {{ selected_fields | tojson }} || [];
    // @ts-ignore - Jinja2 template syntax, will be processed by server
    const fieldsDescriptions = {{ fields_descriptions | tojson }} || {};
    
    let exampleCounter = 1;
    
    // Функция создания блока примера
    function createExampleBlock(exampleNumber, isFirst = false) {
        const block = document.createElement('div');
        block.className = 'example-block';
        block.setAttribute('data-example-index', exampleNumber);
        
        let headerHTML = `<div class="example-header">
            <div class="example-title">Пример ${exampleNumber}</div>`;
        
        if (!isFirst) {
            headerHTML += `<button type="button" class="example-delete-btn" onclick="deleteExampleBlock(this)">-</button>`;
        }
        
        headerHTML += `</div>`;
        
        let fieldsHTML = '';
        selectedFields.forEach(fieldKey => {
            const fieldDescription = fieldsDescriptions[fieldKey] || fieldKey;
            fieldsHTML += `
                <div class="field-input-group">
                    <label class="field-label">${fieldDescription}</label>
                    <textarea 
                        class="field-textarea" 
                        name="example_${exampleNumber}_${fieldKey}"
                        rows="1"></textarea>
                </div>
            `;
        });
        
        block.innerHTML = headerHTML + fieldsHTML;
        return block;
    }
    
    // Функция удаления блока примера
    function deleteExampleBlock(button) {
        const block = button.closest('.example-block');
        block.remove();
        updateExampleNumbers();
    }
    
    // Функция обновления номеров примеров после удаления
    function updateExampleNumbers() {
        const blocks = document.querySelectorAll('.example-block');
        blocks.forEach((block, index) => {
            const newNumber = index + 1;
            const titleElement = block.querySelector('.example-title');
            if (titleElement) {
                titleElement.textContent = `Пример ${newNumber}`;
            }
            
            // Обновляем имена полей
            block.setAttribute('data-example-index', newNumber);
            const textareas = block.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                const nameMatch = textarea.name.match(/^example_(\d+)_(.+)$/);
                if (nameMatch) {
                    textarea.name = `example_${newNumber}_${nameMatch[2]}`;
                }
            });
        });
    }
    
    // Функция автоматического изменения высоты textarea
    function autoResizeTextarea(textarea) {
        // Сбрасываем высоту, чтобы получить правильную scrollHeight
        textarea.style.height = 'auto';
        // Устанавливаем высоту равной scrollHeight (содержимое + padding)
        textarea.style.height = textarea.scrollHeight + 'px';
    }
    
    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('examples-container');
        
        // Создаем первый блок примера
        const firstBlock = createExampleBlock(1, true);
        container.appendChild(firstBlock);
        
        // Инициализируем автоизменение высоты для всех textarea
        const allTextareas = document.querySelectorAll('.field-textarea');
        allTextareas.forEach(textarea => {
            // Устанавливаем начальную высоту
            autoResizeTextarea(textarea);
            
            // Обработчик изменения содержимого
            textarea.addEventListener('input', function() {
                autoResizeTextarea(this);
            });
        });
        
        // Обработчик кнопки добавления примера
        document.getElementById('add-example-btn').addEventListener('click', function() {
            exampleCounter++;
            const newBlock = createExampleBlock(exampleCounter, false);
            container.appendChild(newBlock);
            
            // Инициализируем автоизменение высоты для новых textarea
            const newTextareas = newBlock.querySelectorAll('.field-textarea');
            newTextareas.forEach(textarea => {
                autoResizeTextarea(textarea);
                textarea.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
            });
        });
    });
</script>
{% endblock %}
